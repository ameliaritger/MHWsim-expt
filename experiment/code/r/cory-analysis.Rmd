---
title: "Corynactis MHWsim experiment data analysis"
author: "Amelia Ritger"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(here)
library(lubridate)
library(ggpmisc) #statpolyeq ggplot
library(forecast) #ARIMA
```

# Load Tidied Data
```{r}
source("mergeAllData.R", local = knitr::knit_global())
```

# Visualize the data

## Data QA/QC plots
```{r}
ggplot(all, aes(x=date, y=diff_n_cont, color=genet)) +
  geom_point() +
  facet_wrap(~treatment) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal()
```

## Plot basic growth rate across entire experiment
```{r}
ggplot(all, aes(x=date, y=growth_rate_cont, color=genet)) +
  facet_wrap(~treatment,
             labeller =  labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  geom_point(alpha=0.5) +
  geom_smooth(method = "lm", formula = y ~ x, se = F) +
  stat_poly_eq(use_label("eq"), formula = y ~ x, na.rm=TRUE) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal() +
  labs(x = "Date",
       y = "Cumulative population growth (no. polyps)",
       color = "Genet")

#ggsave(here("experiment", "figures", "growth_genet.png"), width=12, height=7)
```

## Plot growth rate of all genets during and after MHW
```{r}
ggplot(all, aes(x=date, y=growth_rate, color = treatment)) +
  geom_point(alpha=0.1) +
  facet_wrap(~mhw, scales="free", labeller = labeller(mhw = c("during" = "During MHW", "after" = "After MHW"))) +
  geom_smooth(method = "lm", formula = y ~ x, se = F) +
  stat_poly_eq(use_label("eq"), formula = y ~ x, parse = TRUE, label.x.npc = "left") +
  scale_color_manual(values = c("cold" = "#0072B2", "severe" = "#E69F00", "extreme" = "#D55E00"),
                     labels = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW")) +
  theme_minimal() +
  coord_cartesian(ylim = c(-5, 25), expand=TRUE) +   #set equal y axes coordinates
  labs(x = "Date",
       y = "Cumulative population growth (no. polyps)",
       color = "Treatment")

#ggsave(here("experiment", "figures", "growth_MHW.png"), width=12, height=7)
```

## Plot growth rate of each genet during and after MHW
```{r}
ggplot(all, aes(x=date, y=growth_rate, color = genet)) +
  geom_point(alpha=0.1) +
  facet_grid(mhw~treatment, 
             #switch = 'x',
             scales = "free_x",
             labeller = labeller(mhw = c("during" = "During MHW", "after" = "After MHW"),
                                 treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  geom_smooth(method = "lm", formula = y ~ x, se = F) +
  stat_poly_eq(use_label("eq"), formula = y ~ x, parse = TRUE, label.x.npc = "left") +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal() +
  #coord_cartesian(ylim = c(-5, 25), expand=TRUE) +   #set equal y axes coordinates
  labs(x = "Date",
       y = "Cumulative population growth (no. polyps)",
       color = "Genet")
  theme(strip.placement = "outside")

#ggsave(here("experiment", "figures", "growth_MHW_genet.png"), width=12, height=10)
```

## Plot growth rate of each genet during and after MHW - but not faceted by MHW
```{r}
label_plot <- c("0.13", "0.09", "0.071", "0.0522", "0.0761",
                "0.151", "0.0933", "0.0252", "0.116", "0.0413", #extreme during
                "0.166", "0.142", "0.0522", "0.134", "0.0902",
                "-0.0023", "0.00741", "0.026", "0.00843", "-0.0131",
                "0.0102", "0.00652", "0.00881", "0.00421", "-0.0117", #extreme after
                "-0.0104", "-0.000895", "0.0217", "0.0127", "-0.0131")
color_plot <- rep(c("#9370DB", "#C21B78", "#FF9933", "#FF3333", "#662B45"), times = 6)
treatment_plot <- rep(c(rep("cold", 5), rep("extreme", 5), rep("severe", 5)), times = 2)
date_plot <- c(rep("2023-10-01", 15), rep("2024-01-10", 15))

p <- ggplot(all, aes(x=date, y=growth_rate_cont, color=genet, shape=mhw)) +
  geom_point(alpha=0.15) +
  facet_wrap(~factor(treatment, levels=c("cold", "severe", "extreme"), labels=c("Ambient", "Severe MHW", "Extreme MHW"))) +   geom_rect(aes(xmin = as.POSIXct("2023-11-30"), xmax = as.POSIXct("2023-12-10"), ymin = -5, ymax = -4.5), color = "dimgray", fill = "dimgray", alpha = 0.4) +  # Add horizontal bar
    geom_rect(aes(xmin = as.POSIXct("2024-02-14"), xmax = as.POSIXct("2024-02-21"), ymin = -5, ymax = -4.5), color = "dimgray", fill = "dimgray", alpha = 0.4) +  # Add horizontal bar
  geom_vline(xintercept = as.POSIXct("2023-12-10"), linetype = "dashed") +  # Add vertical line delineating during/after MHW
  geom_smooth(method = "lm", se = FALSE) +
  #stat_poly_eq(use_label("eq"), formula = y ~ x, parse = TRUE) +  #un-comment this to get updated values to add to label_plot
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_shape_manual(values = c("during" = 16, "after" = 17)) +  # Define shapes for mhw levels
  theme_minimal() +
  coord_cartesian(ylim = c(-5, 25), expand=TRUE) +
  labs(x = "Date",
       y = "Cumulative population growth (no. polyps)",
       color = "Genet") +
  guides(shape = "none")

loop_count = 0
for (i in 1:length(label_plot)) {
  p <- p + geom_text(data = data.frame(date = as.Date("2023-12-30"), treatment = treatment_plot[i], mhw = "during"), 
              label=paste0("m = ", label_plot[i]), x = as.Date(date_plot[i]), y = 25-loop_count, hjust = 0, vjust = 1, color=color_plot[i])
  loop_count <- loop_count + 1
  if (loop_count > 4) {
    loop_count <- 0  # Reset counter after every 5th iteration
  }
}
p

#ggsave(here("experiment", "figures", "growth_MHW_genet_combined.png"), width=12, height=7)
```

## Plot raw population numbers
```{r}
g <- ggplot(all, aes(x=date, y=n_true, color=genet, shape=mhw)) +
  geom_point(alpha=0.15) +
  facet_wrap(~factor(treatment, levels=c("cold", "severe", "extreme"), labels=c("Ambient", "Severe MHW", "Extreme MHW"))) +
  geom_rect(aes(xmin = as.POSIXct("2023-11-30"), xmax = as.POSIXct("2023-12-10"), ymin = 5, ymax = 5.5), color = "dimgray", fill = "dimgray", alpha = 0.2) +  # Add horizontal bar
  geom_rect(aes(xmin = as.POSIXct("2024-02-14"), xmax = as.POSIXct("2024-02-21"), ymin = 5, ymax = 5.5), color = "dimgray", fill = "dimgray", alpha = 0.2) +  # Add horizontal bar
  geom_vline(xintercept = as.POSIXct("2023-12-10"), linetype = "dashed", linewidth = 0.5) +  # Add vertical line delineating during/after MHW
  geom_smooth(method = "lm", se = FALSE) +
 # stat_poly_eq(use_label("eq"), formula = y ~ x, parse = TRUE) +  
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_shape_manual(values = c("during" = 16, "after" = 17)) +  # Define shapes for mhw levels
  theme_minimal() +
  #coord_cartesian(ylim = c(5, 40), expand=TRUE) +
  labs(x = "Date",
       y = "Number of polyps",
       color = "Genet") +
  guides(shape = "none")

loop_count = 0
for (i in 1:length(label_plot)) {
  g <- g + geom_text(data = data.frame(date = as.Date("2023-12-30"), treatment = treatment_plot[i], mhw = "during"), 
              label=paste0("m = ", label_plot[i]), x = as.Date(date_plot[i]), y = 40-loop_count, hjust = 0, vjust = 1, color=color_plot[i])
  loop_count <- loop_count + 1
  if (loop_count > 4) {
    loop_count <- 0  # Reset counter after every 5th iteration
  }
}
g

#ggsave(here("experiment", "figures", "n_MHW_genet_combined.png"), width=12, height=7)
```

## Plot behavior data
```{r}
# %closed facet grid
ggplot(all, aes(x=genet, y=percent_closed, fill=genet, group=genet)) +
  geom_point(aes(color=genet)) +
  geom_violin(position="dodge", alpha=0.5, outlier.colour="transparent") +
  facet_grid(mhw~treatment)

# %closed facet wrap
ggplot(all, aes(x = genet, y = percent_closed, fill = genet, group = interaction(genet, mhw), shape = mhw)) +
  geom_point(aes(color = genet), position = position_dodge(width = 0.9)) +
  geom_violin(aes(size = mhw), position = position_dodge(width = 0.9), alpha = 0.5, outlier.colour = "transparent") +
  facet_wrap(~treatment) +
  scale_size_manual(values = c("during" = 1, "after" = 0.5)) + # Define sizes for mhw levels
  scale_shape_manual(values = c("during" = 16, "after" = 17))  # Define shapes for mhw levels

# %fullyOpen facet wrap
ggplot(all, aes(x = genet, y = percent_fully_open, fill = genet, group = interaction(genet, mhw), shape = mhw)) +
  geom_point(aes(color = genet), position = position_dodge(width = 0.9), alpha = 0.5) +
  geom_violin(aes(size = mhw), position = position_dodge(width = 0.9), alpha = 0.3, color = alpha("black", 0.75)) +
  facet_wrap(~treatment,
             labeller =  labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  scale_size_manual(values = c("during" = 1, "after" = 0.5), labels = c("During MHW", "After MHW")) + # Define sizes for mhw levels
  scale_shape_manual(values = c("during" = 16, "after" = 17), labels = c("During MHW", "After MHW")) + # Define shapes for mhw levels
  # change color of violin 
  scale_fill_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal() +
  labs(x = "Genet",
       y = "% open polyps",
       color = "Genet",
       shape = "MHW",
       size = "MHW") +
  guides(fill = "none",
         color = "none")

#ggsave(here("experiment", "figures", "open_MHW_genet.png"), width=12, height=7)
```

## Plot total biomass over time
```{r}
ggplot(all, aes(x=date, y=total_biomass_true)) +
  geom_point(aes(color=genet), size=0.5) +
  geom_smooth(aes(fill=genet, color=genet), method="lm", se=T) +
  facet_wrap(~treatment,
             labeller =  labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  scale_fill_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal() +
  labs(x = "Date",
       y = "Total biomass (g)",
       color = "Genet",
       fill = "Genet")

#ggsave(here("experiment", "figures", "total_biomass_mhw.png"), width=12, height=7)
```

## Plot average body size over time
```{r}
ggplot(all, aes(x=date, y=avg_size)) +
  geom_point(aes(color=genet), size=0.5) +
  geom_smooth(aes(fill=genet, color=genet), method="loess", se=T) +
  facet_wrap(~treatment,
             labeller =  labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  scale_fill_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal() +
  labs(x = "Date",
       y = "Average body size (mm)",
       color = "Genet",
       fill = "Genet")

#ggsave(here("experiment", "figures", "avg_size_mhw.png"), width=12, height=7)
```

## Plot mortality (lol)
```{r}
ggplot(all, aes(x=date, y=dying_dead, color = treatment)) +
  geom_point(alpha=0.1) +
  facet_wrap(~treatment, 
             labeller = labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  geom_smooth(method = "lm", formula = y ~ x, se = F) +
  scale_color_manual(values = c("cold" = "#0072B2", "severe" = "#E69F00", "extreme" = "#D55E00")) +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0, 10, 2), limits = c(0, 10), labels = function(x) format(x, nsmall = 0)) +
  labs(x = "Date",
       y = "Mortality (no. polyps)",
       color = "Treatment") +
  guides(color = "none")

#ggsave(here("experiment", "figures", "mortality_MHW.png"), width=12, height=7)
```

############################################################################################################

# Start running stats

## Count data - GLARMA 
```{r}

```

## Body size data - Autoregression
### Log transform data
```{r}
all_transform <- all %>%
  filter(!is.na(avg_size)) %>%
  mutate(avg_size_log = log(avg_size))

# histogram of raw data
ggplot(all_transform, aes(x=avg_size)) +
  geom_histogram(binwidth=0.1) +
  labs(x = "Average body size (mm)",
       y = "Frequency")
# raw data density plot
ggplot(all_transform, aes(x = avg_size)) +
  geom_density() +
  ggtitle("Density Plot of Original Data")
# Q-Q plot of original data
qqnorm(all_transform$avg_size)
qqline(all_transform$avg_size, col = "red")

# histogram of transformed data
ggplot(all_transform, aes(x=avg_size_log)) +
  geom_histogram(binwidth=0.1) +
  labs(x = "log(Average body size (mm))",
       y = "Frequency")
# transformed data density plot
ggplot(all_transform, aes(x = avg_size_log)) +
  geom_density() +
  ggtitle("Density Plot of Transformed Data")
# Q-Q plot of log-transformed data
qqnorm(all_transform$avg_size_log)
qqline(all_transform$avg_size_log, col = "red")
```
It's not perfectly normal but definitely better log-transformed

```{r}
# Perform ADF test to check if data is stationary
adf.test(all_transform$avg_size_log)
# Plot ACF and PACF for the stationary log-transformed body size
Acf(all_transform$avg_size_log)
Pacf(all_transform$avg_size_log)

diff_series <- diff(all_transform$avg_size_log)
Acf(diff_series, main = "ACF of Differenced Series")
Pacf(diff_series, main = "PACF of Differenced Series")
```
Seasonal cycle has lag of 5 for whatever reason

```{r}
# Seasonal differencing
diff_series_seasonal <- diff(all_transform$avg_size_log, lag = 5)

Acf(diff_series_seasonal, main = "Seasonal ACF of Differenced Series")
Pacf(diff_series_seasonal, main = "Seasonal PACF of Differenced Series")
```
According to ChatGPT:
*Strong Peak at Lag 5 in ACF:*
The significant negative peak at lag 5 in the ACF suggests a strong seasonal effect with a period of 5 time units. This indicates that the data has a seasonal pattern with a period of 5 lags.

*Wave Pattern in ACF:*
The wave-like pattern with small positive and negative values elsewhere suggests that the seasonality is prominent at lag 5, but the data beyond this lag doesnâ€™t exhibit strong autocorrelation. This is typical in many time series where the primary seasonality is evident at specific lags, and other autocorrelations diminish.

*Strong Peak at Lag 5 in PACF:*
A strong peak at lag 5 in the PACF suggests that there is a significant seasonal autoregressive (AR) component. This means that past values separated by a season (5 lags in your case) have a strong influence on the current value.

*Wave Pattern in PACF:*
The wave-like pattern with small values elsewhere in the PACF indicates that the influence of past values diminishes quickly after lag 5, reinforcing the idea that lag 5 is the primary seasonal effect.

**Determining Seasonal AR and MA Orders**
*Seasonal AR (PP):*
Since the PACF shows a strong peak at lag 5 and then cuts off or shows a diminishing pattern, it indicates a seasonal AR component. You might start with P=1 or P=2, but the specific choice will depend on how well it fits the data. In this case, P could be 1 if the PACF cuts off or diminishes significantly after lag 5.

*Seasonal MA (QQ):*
The ACF shows a strong peak at lag 5 and then diminishes. This suggests that a seasonal MA component is appropriate. Typically, Q=1 is a good starting point, but it can be adjusted based on model performance.

*Seasonal Differencing (DD):*
If the seasonal pattern persists despite differencing, you might need to include seasonal differencing (DD). Since your ACF and PACF both show strong patterns at lag 5, D=1 is likely appropriate to handle seasonal trends.

```{r}
fit_auto <- auto.arima(all_transform$avg_size_log, seasonal = TRUE, stepwise = FALSE, approximation = FALSE)
summary(fit_auto)
residuals_auto <- residuals(fit_auto)
plot(residuals_auto, main = "Residuals of AUTOSARIMA Model")
Acf(residuals_auto, main = "ACF of Residuals")
Box.test(residuals_auto, type = "Ljung-Box")
```

```{r}
# Fit ARIMA with different seasonal orders
model1 <- Arima(all_transform$avg_size_log, order = c(5, 1, 1), seasonal = list(order = c(1, 1, 1), period = 5))
model3 <- Arima(all_transform$avg_size_log, order = c(5, 1, 1), seasonal = list(order = c(1, 1, 1), period = 5))

Acf(residuals(model1), main = paste("ACF of Residuals model1"))
Pacf(residuals(model1), main = paste("PACF of Residuals model1"))

Acf(residuals(model2), main = paste("ACF of Residuals model2"))
Pacf(residuals(model2), main = paste("PACF of Residuals model2"))

Acf(residuals(model3), main = paste("ACF of Residuals model3"))
Pacf(residuals(model3), main = paste("PACF of Residuals model3"))

Box.test(residuals(model1), lag = 20, type = "Ljung-Box")
Box.test(residuals(model2), lag = 20, type = "Ljung-Box")
Box.test(residuals(model3), lag = 20, type = "Ljung-Box")
```

```{r}
# Fit the model
fit <- Arima(all_transform$avg_size_log, order = c(5, 1, 1), seasonal = list(order = c(1, 1, 1), period = 5))

# Residuals and Diagnostics
plot(residuals_fit, main = "Residuals")
Acf(residuals_fit, main = "ACF of Residuals")
Pacf(residuals_fit, main = "PACF of Residuals")
qqnorm(residuals_fit, main = "QQ Plot of Residuals")
qqline(residuals_fit)
```



```{r}
fit_auto <- auto.arima(all_transform$avg_size_log, seasonal = TRUE, stepwise = FALSE, approximation = FALSE)
summary(fit_auto)
residuals_auto <- residuals(fit_auto)
plot(residuals_auto, main = "Residuals of AUTOSARIMA Model")
Acf(residuals_auto, main = "ACF of Residuals")
Box.test(residuals_auto, type = "Ljung-Box")
```

```{r}
# Fit SARIMA model
fit_sarima <- arima(all_transform$avg_size_log,
                     order = c(2, 1, 1),            # Non-seasonal orders (p, d, q)
                     seasonal = list(order = c(1, 1, 1), period = 5)) # (P, D, Q)
summary(fit_sarima)
residuals_sarima <- residuals(fit_sarima)
plot(residuals_sarima, main = "Residuals of SARIMA Model") + abline(h = 0, col = "red", lty = 2)
Acf(residuals_sarima, main = "ACF of Residuals")
Pacf(residuals_sarima, main = "PACF of Residuals")
Box.test(residuals_sarima, type = "Ljung-Box")
```


```{r}
# Fit an ARIMA model for each treatment and color
# Create a function to fit ARIMA model for each subset of data
fit_arima <- function(all_transform) {
  # Fit ARIMA model on the log-transformed body size
  arima_model <- Arima(all_transform$avg_size_log, order = c(5, 1, 1), seasonal = list(order = c(1, 1, 1), period = 5))
  return(arima_model)
}

# Apply the function to each combination of treatment and color
models <- all_transform %>%
  group_by(treatment, genet, mhw) %>%
  group_modify(~ {
    model <- fit_arima(.x)
    tibble(model = list(model))
  })

# Check the fitted models
models

# To predict future values, use the fitted model on new data
# Example for one combination of treatment and color
example_model <- models$model[1]
future_predictions <- forecast(example_model, h = 10)  # Forecast 10 periods ahead

# Print the forecasted values
print(future_predictions)
```



